---
- name: Load additional .zshrc files
  ansible.builtin.blockinfile:
    path: "{{ lookup('env', 'ZDOTDIR') }}/.zshrc"
    marker: "# {mark} ANSIBLE MANAGED .myzshrc"
    state: present
    insertbefore: "BOF"
    block: |
      source "$ZDOTDIR/.myzshrc"

- name: Download zephyr
  ansible.builtin.git:
    repo: "https://github.com/mattmc3/zephyr"
    version: "HEAD"
    force: true
    dest: "{{ lookup('env', 'ZDOTDIR') }}/.zephyr"
    single_branch: true
    depth: 1

- name: Download zephyr deps
  ansible.builtin.git:
    repo: "https://github.com/{{ item }}"
    version: "HEAD"
    force: true
    dest: "{{ lookup('env', 'ZDOTDIR') }}/.zephyr/.external/{{ item }}"
    single_branch: true
    depth: 1
  with_items:
    - "zsh-users/zsh-completions"

- name: Download antidote
  ansible.builtin.git:
    repo: "https://github.com/mattmc3/antidote.git"
    version: "HEAD"
    force: true
    dest: "{{ lookup('env', 'ZDOTDIR') }}/.antidote"
    single_branch: true
    depth: 1

- name: Install starship
  ansible.builtin.command:
    cmd: "conda run -n base cargo install starship --locked"
    creates: "{{ lookup('env', 'XDG_BIN_HOME') }}/starship"
  changed_when: true

- name: Link .myzsh files
  ansible.builtin.file:
    src: "{{ dotfiles }}/ZDOTDIR/{{ item }}"
    dest: "{{ lookup('env', 'ZDOTDIR') }}/{{ item }}"
    state: link
  with_items:
    - ".myzshrc"
    - "functions"
    - "zshrc.d"
    - ".zsh_plugins.txt"
