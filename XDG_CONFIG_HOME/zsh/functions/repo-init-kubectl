# shellcheck shell=bash
# shellcheck disable=SC2168
# vi: ft=sh

#function repos/repo-init-kubectl {
if [[ -z $CONDA_PREFIX ]]; then
	>&2 echo "Conda environment not active!"
	return 1
fi

mkdir -p "$CONDA_PREFIX"/bin "$CONDA_PREFIX"/etc

local arch="arm64"
if [[ "$(uname -m)" == "x86_64" ]]; then
	arch="amd64"
fi

local version="$1"
if [[ -z $1 ]]; then
	version=$(curl -L -s https://dl.k8s.io/release/stable.txt)
fi

curl -LO --output-dir "$CONDA_PREFIX"/bin "https://dl.k8s.io/release/$version/bin/linux/$arch/kubectl"
chmod +x "$CONDA_PREFIX"/bin/kubectl

if [[ -f /tmp/config ]]; then
	# requires having run docker cp ~\.kube\config stable-dev-container:/tmp on the host
	# this is to grab the kubeconfig generated by docker desktpo
	sudo cp /tmp/config "$CONDA_PREFIX"/etc/kubeconfig
	sudo chown "$USERNAME":"$USERNAME" "$CONDA_PREFIX"/etc/kubeconfig
	chmod og-r "$CONDA_PREFIX"/etc/kubeconfig
else
	touch "$CONDA_PREFIX"/etc/kubeconfig
fi
conda env config vars set KUBECONFIG="$CONDA_PREFIX"/etc/kubeconfig

# No configuration of the helm version for now
curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | HELM_INSTALL_DIR="$CONDA_PREFIX"/bin bash
sudo chown "$USERNAME":"$USERNAME" "$CONDA_PREFIX"/bin/helm
#}
